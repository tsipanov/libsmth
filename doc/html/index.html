<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libsmth: libsmth internals documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>libsmth internals documentation </h1>  </div>
</div>
<div class="contents">
<h3 class="version">0.0.2 </h3><h2><a class="anchor" id="alfa"></a>
Welcome</h2>
<p>This is to document thouroughly the internals of libsmth. Note that only internal developers should read this. If you simply wish to link against this lib, you may want to check out <code>README</code>.</p>
<h2><a class="anchor" id="beta"></a>
Brief introduction to Smooth Streaming key concepts</h2>
<h3><a class="anchor" id="anna"></a>
Packet (Box) structure</h3>
<p>Each <code><a class="el" href="structFragment.html" title="Will hold the parsed fragment data.">Fragment</a></code> contains a chunk of audio, video or text data, with a metadata header. Each functional block of the fragment was named <code><a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a></code>. Each <code><a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a></code> has a fixed structure:</p>
<div class="fragment"><pre class="fragment">
~-----------+------+-----------------+------------+-------------~
~ BoxLenght | Name | [BoxLongLenght] | BoxFields  | BoxChildren ~
~    4B     |  4B  |  8B (optional)  | {variable} |  {variable} ~
~-----------+------+-----------------+------------+-------------~
</pre></div><p>where:</p>
<ul>
<li><code>Length</code> is the length of the box in bytes, encoded in network format. If the value of the field is 1, the BoxLongLength field must be present. Otherwise, we assert that it is not present. Size includes all the fields, even BoxLenght itself. </li>
<li><code>Name</code> is a 4B non null-terminated string identifying the type of the block. There are seven different types, as it will be explained in the appropriate section. </li>
<li><code>LongLenght</code> is the length of the <a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a> in bytes, encoded in network format. This field is present only if the size of the <code><a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a></code> is larger than BoxLenght max size (32B).</li>
</ul>
<ul>
<li><code>Fields&amp;Children</code> are respectively the attributes and the content of the <code><a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a></code> and may vary accordingly to the role of the respective <code><a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a></code>.</li>
</ul>
<p>The syntax of each <code><a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a></code> is a strict subset of the syntax of the respective <a class="el" href="structFragment.html" title="Will hold the parsed fragment data.">Fragment</a> <a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a> defined in [<code>ISOFF</code>].</p>
<h3><a class="anchor" id="bebba"></a>
Fragment Structure</h3>
<p>As stated before, a <a class="el" href="structFragment.html" title="Will hold the parsed fragment data.">Fragment</a> Response is composed of various <code>Boxes</code>,</p>
<div class="fragment"><pre class="fragment">
~------------+------------~
~   MoofBox  |  MdatBox   ~
~ {variable} | {variable} ~
~------------+------------~
</pre></div><p>Each <code><a class="el" href="structBox.html" title="Holds stream and metadata of currently parsed Box.">Box</a></code> must contain certain sub-Boxes, and it may contain others. Any block may contain one or more <code>VendorExtensionUUIDBox</code>, as described later.</p>
<h3><a class="anchor" id="cedda"></a>
Manifest Response</h3>
<p>According to the specifications, the <a class="el" href="structManifest.html" title="Holds the manifest data of the opened stream.">Manifest</a> must be a Well-Formed <code>XML</code> Document subject to the following constraints:</p>
<ul>
<li>The Document's <code>XML</code> Declaration's major version is <code>1</code>. </li>
<li>The Documentâ€™s <code>XML</code> Declaration's minor version is <code>0</code>. </li>
<li>The Document does not use a Document Type Definition (<code>DTD</code>). </li>
<li>The Document uses an encoding that is supported by the Client. </li>
<li>The XML Elements specified in this document do not use <code>XML</code> Namespaces.</li>
</ul>
<h2><a class="anchor" id="gamma"></a>
Quick overview</h2>
<h3><a class="anchor" id="abba"></a>
Public API</h3>
<p>The main API exposed by libsmth is composed of five functions: </p>
<ul>
<li><code>SMTH_open</code> : Opens a stream with the given url and params </li>
<li><code>SMTH_getinfo:</code> Get various metadata about the playing stream </li>
<li><code>SMTH_EOS:</code> signals whether the end of the selected stream has been reached </li>
<li><code>SMTH_read</code> : Performs a read on the pseudofile object returned by SMTH_open </li>
<li><code>SMTH_close</code> : Closes the handle. Note that SMTHh is <em>not</em> a <code>FILE</code> like object: it <em>must</em> be destroyed with a call to SMTH_close.</li>
</ul>
<h3><a class="anchor" id="dadda"></a>
Example</h3>
<p>Here is a tiny example of how the lib may be used to read a single chunk from a given stream:</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * Copyright (C) 2010 Stefano Sanfilippo</span>
<span class="comment"> *</span>
<span class="comment"> * smth-test.c : test program from docs</span>
<span class="comment"> *</span>
<span class="comment"> * This program is free software; you can redistribute it and/or modify</span>
<span class="comment"> * it under the terms of the GNU Library General Public License as published</span>
<span class="comment"> * by the Free Software Foundation; either version 2 of the License, or</span>
<span class="comment"> * (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment"> * GNU General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU General Public License</span>
<span class="comment"> * along with this program; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="smth_8h.html" title="libsmth public API">smth.h</a>&gt;</span>

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)
{
    <a class="code" href="smth_8h.html#a9fa02bbe9e9e4543f1170b6de20ebefe" title="Pseudofile handle, declared as an opaque pointer.">SMTHh</a> h;
    <span class="keywordtype">char</span> buffer[8192];
    <span class="keywordtype">int</span> i, fragnum = 0;
    <span class="keywordtype">size_t</span> streamsno;  <span class="comment">/* total number of streams */</span>
    <span class="keywordtype">char</span> *name;

    <span class="keywordflow">if</span> (argc &lt; 2)
    {
        fprintf(stderr, <span class="stringliteral">&quot;Usage: %s url\n&quot;</span>, argv[0]);
        <span class="keywordflow">return</span> -1;
    }

    h = <a class="code" href="smth_8c.html#af5659990ee2172abc57f8d342b94cbfe" title="Opens an url for a Smooth Stream and registers a handle, which will be used to fetch data with subseq...">SMTH_open</a>(argv[1], 0);

    <span class="keywordflow">if</span> (!h) <span class="keywordflow">return</span> -1;

    <a class="code" href="smth_8c.html#ab7451f39291bddba9fe16ac4d276efdc" title="Gets the specified setting value for currently parsed stream and stores it into destination. If an invalid setting is requested, dest is nulled.">SMTH_getinfo</a>(<a class="code" href="smth_8h.html#aed37c1564fde19a2e9803df5a3c0b640ac93a28b9a401a0b0859e5a7c039e7823">SMTH_STREAMS_NO</a>, h, &amp;streamsno);

    <span class="keywordflow">for</span> (i = 0; i &lt; streamsno; ++i)
    {
        <a class="code" href="smth_8c.html#ab7451f39291bddba9fe16ac4d276efdc" title="Gets the specified setting value for currently parsed stream and stores it into destination. If an invalid setting is requested, dest is nulled.">SMTH_getinfo</a>(<a class="code" href="smth_8h.html#aed37c1564fde19a2e9803df5a3c0b640ab582b089bdc6ab1bfccd75cf5a79db18">SMTH_NAME</a>, h, i, &amp;name);
        fprintf(stderr, <span class="stringliteral">&quot;Downloading chunks from stream %s\n&quot;</span>, name);
        free(name); <span class="comment">// this is very important! it&#39;s up to you to free strings</span>

        <span class="keywordflow">for</span> (fragnum = 0; !<a class="code" href="smth_8c.html#a23ba0c9c51d59e4c587e8d061d327661" title="Signals whether a stream is over.">SMTH_EOS</a>(h, i); ++fragnum)
        {
            <span class="keywordtype">size_t</span> written = -1;

            <span class="keywordtype">char</span> filename[100];
            snprintf(filename, 100, <span class="stringliteral">&quot;fragment-%d-%d.vc1&quot;</span>, i, fragnum);
            FILE *output = fopen(filename, <span class="stringliteral">&quot;w&quot;</span>);

            <span class="keywordflow">while</span> (written)
            {
                written = <a class="code" href="smth_8c.html#ab30aa71f87eb65a7d56e9cab0c494878" title="Reads at most size bytes from Stream stream into buffer using Handle h.">SMTH_read</a>(buffer, <span class="keyword">sizeof</span> (buffer), i, h);
                fwrite(buffer, written, 1, output);
            }

            fclose(output);
        }
    }

    <a class="code" href="smth_8c.html#a5ed2be3f1863e0ae158434f34edf5990" title="Closes a SMTHh handle.">SMTH_close</a>(h);

    <span class="keywordflow">return</span> 0;
}

</pre></div><p>Usage is self-explanatory. Should you need more power, you can rely on the internal API, as documented below. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

	<hr class="footer"/>
	<address style="text-align: right;"><small>
		Generated on Tue Dec 21 2010 15:46:42 for libsmth by
		<a href="http://www.doxygen.org/index.html"/>Doxygen</a>
		1.7.1
	</small></address>
</body>
</html>
